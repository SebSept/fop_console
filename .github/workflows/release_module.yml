name: "Release : Draft & add module asset."

on:
  push:
    tags:
      - "*"

jobs:
  ps_release:
    runs-on: "ubuntu-latest"

    steps:
      - name: "Setup zip filename. Exports $MODULE_NAME, $VERSION & $ZIP_FILE"
        run: |
          MODULE_NAME=${GITHUB_REPOSITORY#*/}
          echo "MODULE_NAME=${MODULE_NAME}" >> $GITHUB_ENV
          REF='${{ github.ref }}'
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          VERSION=${REF#refs/*/}
          echo "ZIP_FILE=${MODULE_NAME}_${VERSION}.zip" >> $GITHUB_ENV

      - name: "Checkout source code"
        uses: "actions/checkout@v2"
        with:
          lfs: true

      - name: "Setup PHP"
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.2'

      - name: "Composer install"
        run: "composer install --no-dev --ansi --prefer-dist --no-interaction --no-progress --quiet"

      - name: "Prepare files"
        run: |
          mkdir newdir
          ls | grep -v newdir | xargs -I{} mv {} newdir
          mv newdir ${{ env.MODULE_NAME }}

      - name: "Archive Release"
        uses: thedoctor0/zip-release@master
        with:
          filename: '${{ env.ZIP_FILE }}'
          exclusions: '*.git* README.md config_*.xml config.xml .php_cs_dist'
          type: 'zip'

      - name: "Upload binaries to release"
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: '${{ env.ZIP_FILE }}'
#          asset_name: '${{ env.ZIP_FILE }}'
          tag: ${{ github.ref }}
          overwrite: true
          body: "release text : erased by next step."

      - name: "Draft"
        uses: release-drafter/release-drafter@v5
        with:
          config-name: release-drafter-config.yml
          disable-autolabeler: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


